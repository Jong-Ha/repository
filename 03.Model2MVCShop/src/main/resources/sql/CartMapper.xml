<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
				
<mapper namespace="CartMapper">

  	<resultMap type="com.model2.mvc.service.domain.Cart" id="cartSelectMap">
  		<result property="cartNo"			column="cart_no"		jdbcType="NUMERIC"/>
  		<result property="userId"			column="user_id"		jdbcType="VARCHAR"/>
  		<result property="amount"			column="amount"			jdbcType="NUMERIC"/>
  		<association property="prod" resultMap="productSelectMap"/>
  	</resultMap>
  	
  	<resultMap type="com.model2.mvc.service.domain.Product" id="productSelectMap">
  		<result property="manuDate"		column="manufacture_day"	jdbcType="VARCHAR"/>
  		<result property="price"		column="price"				jdbcType="NUMERIC"/>
  		<result property="prodDetail"	column="prod_detail"		jdbcType="VARCHAR"/>
  		<result property="prodName"		column="prod_name"			jdbcType="VARCHAR"/>
  		<result property="prodNo"		column="prod_no"			jdbcType="NUMERIC"/>
  		<result property="regDate"		column="reg_date"			jdbcType="DATE"/>
  		<result property="rowNum"		column="row_num"			jdbcType="VARCHAR"/>
  		<result property="amount"		column="product_amount"		jdbcType="NUMERIC"/>
  		<result property="proTranCode"	column="tran_code"			jdbcType="VARCHAR"/>
  		<association property="mainFile" column="prod_no" javaType="file" select="getMainFile"/>
  	</resultMap>
  	
  	<resultMap type="file" id="fileResultMap">
		<id property="refKey" 			column="ref_key" 		jdbcType="NUMERIC"/>
		<result property="fileName" 		column="file_name" 		jdbcType="VARCHAR"/>
		<result property="originalFileName"	column="original_name" 	jdbcType="VARCHAR"/>
		<result property="path" 			column="path" 			jdbcType="VARCHAR"/>
		<result property="size" 			column="file_size" 		jdbcType="NUMERIC"/>
		<result property="imageType" 		column="image_type" 	jdbcType="NUMERIC"/>
		<result property="target" 			column="target" 		jdbcType="VARCHAR"/>
  	</resultMap>
  	
  	<select id="getMainFile" resultMap="fileResultMap">
  		SELECT ref_key, file_name, original_name, path, file_size, image_type, target
  		FROM files
  		<where>
  			target = 'product'
  			AND ref_key = #{prodNo}
  			AND image_type = 'main'
  		</where>
  	</select>
  	
  	<select id="checkCart" parameterType="cart" resultType="int">
  		SELECT cart_no FROM cart
  		<where>
  			user_id = #{userId}
  			AND prod_no = #{prod.prodNo}
  		</where>
  	</select>
  	
  	<select id="checkProduct" parameterType="int" resultType="int">
  		SELECT amount FROM product
  		<where>
  			prod_no = #{prodNo}
  		</where>
  	</select>
  	
  	<update id="updateCart" parameterType="cart">
  		UPDATE cart
  		<set>
  			<if test="prod.prodName != null">amount = amount+#{amount}</if>
  			<if test="prod.prodName == null">amount = #{amount}</if>
  		</set>
  		<where>
  			cart_no = #{cartNo}
  		</where>
  	</update>
  	
  	<insert id="addCart" parameterType="cart">
  		INSERT
  		INTO cart(cart_no,user_id,prod_no,amount)
  		VALUES(	seq_cart_cart_no.NEXTVAL,
  				#{userId:VARCHAR},
  				#{prod.prodNo:INTEGER},
  				#{amount:INTEGER}	)
  	</insert>
  	
  	<select id="getCartList" parameterType="string" resultMap="cartSelectMap">
  		SELECT
  		c.cart_no,c.user_id,c.prod_no,c.amount,p.prod_name,p.prod_detail,p.price,p.amount AS product_amount
  		FROM cart c, product p
  		<where>
  			c.prod_no = p.prod_no
  			AND user_id = #{userId}
  		</where>
  		ORDER BY c.cart_no
  	</select>
  	
  	<delete id="deleteCart" parameterType="int">
  		DELETE FROM cart
  		<where>
  			cart_no = #{cartNo}
  		</where>
  	</delete>
  	
  	<delete id="deleteCartList" parameterType="list">
  		DELETE FROM cart
  		<where>
  			cart_no IN
  			<foreach collection="list" item="cartNo" open="(" separator="," close=")">#{cartNo}</foreach>
  		</where>
  	</delete>
  	
</mapper>